{
  "type": "workflow_collections",
  "data": [
    {
      "@context": "/api/3/contexts/WorkflowCollection",
      "@type": "WorkflowCollection",
      "name": "CIS Compliance",
      "description": "Playbooks for CIS compliance data ingestion.",
      "visible": true,
      "image": null,
      "uuid": "f21d72c7-3d95-4bb8-8b42-1a2f1e0c1b01",
      "workflows": [
        {
          "@type": "Workflow",
          "triggerLimit": null,
          "name": "Ingest CIS Rules (Legacy CSV)",
          "aliasName": null,
          "tag": null,
          "description": "Manual CSV ingestion into legacy CIS Rule.",
          "isActive": true,
          "debug": true,
          "singleRecordExecution": false,
          "remoteExecutableFlag": false,
          "parameters": [
            "csv_url",
            "csv_text",
            "code_snippet_config"
          ],
          "synchronous": false,
          "collection": "/api/3/workflow_collections/f21d72c7-3d95-4bb8-8b42-1a2f1e0c1b01",
          "versions": [],
          "triggerStep": "/api/3/workflow_steps/1560be3a-ada9-4177-a291-8730007e9e18",
          "steps": [
            {
              "@type": "WorkflowStep",
              "name": "Start",
              "description": "Manual trigger with CSV file upload.",
              "arguments": {
                "__triggerLimit": true,
                "step_variables": {
                  "input": {
                    "params": [
                      {
                        "name": "csv_file",
                        "type": "file",
                        "title": "CIS Rules CSV"
                      },
                      {
                        "name": "csv_url",
                        "type": "text",
                        "title": "CIS Rules CSV URL (optional)"
                      },
                      {
                        "name": "csv_text",
                        "type": "text",
                        "title": "CIS Rules CSV Text (optional)"
                      },
                      {
                        "name": "code_snippet_config",
                        "type": "text",
                        "title": "Code Snippet Config UUID"
                      },
                      {
                        "name": "fsr_base_url",
                        "type": "text",
                        "title": "FortiSOAR Base URL (optional)"
                      },
                      {
                        "name": "fsr_api_key",
                        "type": "text",
                        "title": "FortiSOAR API Key (optional)"
                      }
                    ]
                  }
                },
                "triggerOnSource": true,
                "triggerOnReplicate": false,
                "noRecordExecution": true,
                "singleRecordExecution": false,
                "resources": [
                  "cis_rule"
                ]
              },
              "status": null,
              "top": "30",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/f414d039-bb0d-4e59-9c39-a8f1e880b18a",
              "group": null,
              "uuid": "1560be3a-ada9-4177-a291-8730007e9e18"
            },
            {
              "@type": "WorkflowStep",
              "name": "Read CSV File",
              "description": "Read CSV contents from uploaded file.",
              "arguments": {
                "step_variables": [],
                "file_contents": "{{ vars.input.csv_file }}"
              },
              "status": null,
              "top": "165",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
              "group": null,
              "uuid": "ebe5e858-be6b-4bb8-8468-ea0c19cac67c"
            },
            {
              "@type": "WorkflowStep",
              "name": "Parse CSV",
              "description": "Parse CSV to list of rule objects.",
              "arguments": {
                "step_variables": [],
                "config": "{{ vars.input.code_snippet_config }}",
                "params": {
                  "python_function": "import csv\nimport io\nimport json\nimport urllib.request\nimport urllib.parse\n\n\ndef get_path(payload, path):\n    cur = payload\n    for key in path:\n        if isinstance(key, int):\n            if not isinstance(cur, list) or key >= len(cur):\n                return None\n            cur = cur[key]\n        else:\n            if not isinstance(cur, dict) or key not in cur:\n                return None\n            cur = cur[key]\n    return cur\n\n\nfsr_base_url = \"{{ vars.input.fsr_base_url | default('https://localhost') }}\"\nfsr_api_key = \"{{ vars.input.fsr_api_key | default('') }}\"\n_benchmark_cache = {}\n\n\ndef resolve_benchmark_iri(name):\n    if not name or not isinstance(name, str):\n        return None\n    if name in _benchmark_cache:\n        return _benchmark_cache[name]\n    if not fsr_api_key:\n        return None\n    base = fsr_base_url.rstrip('/')\n    try:\n        req = urllib.request.Request(\n            f\"{base}/api/3/cis_benchmark?search={urllib.parse.quote(name)}&$limit=1\",\n            headers={\"Authorization\": f\"API-KEY {fsr_api_key}\", \"Accept\": \"application/json\"}\n        )\n        with urllib.request.urlopen(req) as response:\n            data = json.load(response)\n        items = data.get('data') or data.get('hydra:member') or []\n        if items:\n            iri = items[0].get('@id') or items[0].get('id') or items[0].get('uuid')\n            if iri and not iri.startswith('/api/3/') and items[0].get('@id'):\n                iri = items[0].get('@id')\n            _benchmark_cache[name] = iri\n            return iri\n    except Exception:\n        return None\n    return None\n\n\ncsv_text_candidates = [\n    \"\"\"{{ vars.input.csv_text | default('') }}\"\"\",\n    \"\"\"{{ vars.input.data.csv_text | default('') }}\"\"\",\n    \"\"\"{{ vars.request.data.csv_text | default('') }}\"\"\",\n    \"\"\"{{ vars.request.data.input.csv_text | default('') }}\"\"\",\n    \"\"\"{{ vars.request.data.params.csv_text | default('') }}\"\"\",\n    \"\"\"{{ vars.request.data.records[0].csv_text | default('') }}\"\"\",\n    \"\"\"{{ vars.input.records[0].csv_text | default('') }}\"\"\"\n]\n\ncsv_url_candidates = [\n    \"{{ vars.input.csv_url | default('') }}\",\n    \"{{ vars.input.data.csv_url | default('') }}\",\n    \"{{ vars.request.data.csv_url | default('') }}\",\n    \"{{ vars.request.data.input.csv_url | default('') }}\",\n    \"{{ vars.request.data.params.csv_url | default('') }}\",\n    \"{{ vars.request.data.records[0].csv_url | default('') }}\",\n    \"{{ vars.input.records[0].csv_url | default('') }}\"\n]\n\nraw_payload_candidates = [\n    \"\"\"{{ (vars.request.data | default({})) | toJSON }}\"\"\",\n    \"\"\"{{ (vars.input.data | default({})) | toJSON }}\"\"\",\n    \"\"\"{{ (vars.input | default({})) | toJSON }}\"\"\"\n]\n\nfile_text = \"\"\"{{ vars.steps.Read_CSV_File.file_contents | default('') }}\"\"\"\n\nfsr_file_text = \"\"\"{{ fsr_steps_result.Read_CSV_File.file_contents | default('') }}\"\"\"\n\ncsv_text = \"\"\nfor candidate in csv_text_candidates:\n    if candidate and candidate.strip():\n        csv_text = candidate\n        break\n\nif not csv_text:\n    csv_url = \"\"\n    for candidate in csv_url_candidates:\n        if candidate and str(candidate).strip():\n            csv_url = str(candidate).strip()\n            break\n    if csv_url:\n        with urllib.request.urlopen(csv_url) as response:\n            csv_bytes = response.read()\n        csv_text = csv_bytes.decode(\"utf-8\", errors=\"replace\")\n\nif not csv_text and file_text and file_text.strip():\n    csv_text = file_text\nif not csv_text and fsr_file_text and fsr_file_text.strip():\n    csv_text = fsr_file_text\n\nif not csv_text:\n    for raw in raw_payload_candidates:\n        if not raw or not raw.strip():\n            continue\n        try:\n            payload = json.loads(raw)\n        except Exception:\n            continue\n        for path in [\n            (\"csv_text\",),\n            (\"csv_url\",),\n            (\"input\", \"csv_text\"),\n            (\"input\", \"csv_url\"),\n            (\"data\", \"csv_text\"),\n            (\"data\", \"csv_url\"),\n            (\"records\", 0, \"csv_text\"),\n            (\"records\", 0, \"csv_url\")\n        ]:\n            value = get_path(payload, path)\n            if isinstance(value, str) and value.strip():\n                if \"url\" in path[-1]:\n                    with urllib.request.urlopen(value.strip()) as response:\n                        csv_bytes = response.read()\n                    csv_text = csv_bytes.decode(\"utf-8\", errors=\"replace\")\n                else:\n                    csv_text = value\n                break\n        if csv_text:\n            break\n\nif not csv_text:\n    raise Exception(\"No CSV provided. Use csv_file upload, csv_url, or csv_text.\")\n\nreader = csv.DictReader(io.StringIO(csv_text))\n\nrequired_fields = [\n    \"name\",\n    \"rule_id\",\n    \"benchmark\",\n    \"level\",\n    \"severity\"\n]\njson_fields = []\n\nrules_list = []\nvalidation_errors = []\n\nrow_index = 1\nfor row in reader:\n    row_index += 1\n    normalized = {}\n    for key, value in row.items():\n        if key is None:\n            continue\n        key = key.strip()\n        if isinstance(value, str):\n            value = value.strip()\n        normalized[key] = value\n\n    missing = [field for field in required_fields if not normalized.get(field)]\n    if missing:\n        validation_errors.append({\n            \"row\": row_index,\n            \"rule_id\": normalized.get(\"rule_id\"),\n            \"missing\": missing\n        })\n        continue\n\nraw_automated = normalized.get(\"automated\")\nif raw_automated in (None, \"\"):\n    parsed_automated = False\nelse:\n    parsed_automated = str(raw_automated).strip().lower() in (\"true\", \"1\", \"yes\", \"y\")\n\n    parsed = {}\n    parsed.update(normalized)\n\n    parsed[\"automated\"] = parsed_automated\n\n    benchmark_value = parsed.get(\"benchmark\")\n    if benchmark_value and isinstance(benchmark_value, str) and not benchmark_value.startswith(\"/api/3/\"):\n        resolved = resolve_benchmark_iri(benchmark_value)\n        if resolved:\n            parsed[\"benchmark\"] = resolved\n        else:\n            validation_errors.append({\n                \"row\": row_index,\n                \"rule_id\": normalized.get(\"rule_id\"),\n                \"benchmark_not_found\": benchmark_value\n            })\n            continue\n\n    for field in json_fields:\n        raw_value = normalized.get(field)\n        if raw_value in (None, \"\"):\n            parsed[field] = None\n            continue\n        if isinstance(raw_value, str) and raw_value.lstrip().startswith(('{', '[')):\n            try:\n                parsed[field] = json.loads(raw_value)\n            except Exception:\n                validation_errors.append({\n                    \"row\": row_index,\n                    \"rule_id\": normalized.get(\"rule_id\"),\n                    \"invalid_json\": field\n                })\n                parsed[field] = raw_value\n        else:\n            parsed[field] = raw_value\n\n    rules_list.append(parsed)\n\nprint(json.dumps({\n    \"rules_list\": rules_list,\n    \"validation_errors\": validation_errors\n}))\n"
                },
                "version": "2.1.4",
                "connector": "code-snippet",
                "operation": "python_inline_code_editor",
                "operationTitle": "Execute Python Code"
              },
              "status": null,
              "top": "300",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/1fdd14cc-d6b4-4335-a3af-ab49c8ed2fd8",
              "group": null,
              "uuid": "a355b90e-9dcd-40f5-b75d-e2f8040db6a3"
            },
            {
              "@type": "WorkflowStep",
              "name": "Ingest CIS Rules",
              "description": "Create CIS Rule records from parsed rules.",
              "arguments": {
                "for_each": {
                  "item": "{{ vars.steps.Parse_CSV.data['code_output'].rules_list }}",
                  "__bulk": true,
                  "parallel": false,
                  "condition": "",
                  "batch_size": 500
                },
                "resource": "{{ vars.item }}",
                "_showJson": false,
                "collection": "/api/3/cis_rule",
                "__recommend": [],
                "step_variables": []
              },
              "status": null,
              "top": "435",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/2597053c-e718-44b4-8394-4d40fe26d357",
              "group": null,
              "uuid": "ebf12744-2bf9-495c-ac66-ea4ccd40b870"
            },
            {
              "@type": "WorkflowStep",
              "name": "Done",
              "description": "Set playbook result and end workflow.",
              "arguments": {
                "step_variables": [],
                "result": "{% set parsed = vars.steps.Parse_CSV.data['code_output'] %}{\"ingested_count\": {{ parsed.rules_list | length }}, \"invalid_count\": {{ parsed.validation_errors | length }}, \"invalid_rows\": {{ parsed.validation_errors | toJSON }} }"
              },
              "status": null,
              "top": "570",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/9dcc4bf5-b6cf-4a5c-b545-1fac3b9e33e6",
              "group": null,
              "uuid": "acd035fe-ea4b-4f0b-ae78-4132e55ae9b3"
            }
          ],
          "routes": [
            {
              "@type": "WorkflowRoute",
              "name": "Start -> Read CSV File",
              "targetStep": "/api/3/workflow_steps/ebe5e858-be6b-4bb8-8468-ea0c19cac67c",
              "sourceStep": "/api/3/workflow_steps/1560be3a-ada9-4177-a291-8730007e9e18",
              "label": null,
              "isExecuted": false,
              "group": null,
              "uuid": "6a6c1d8f-2a5d-4f08-8f47-9b2f1b8b2a90"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Read CSV File -> Parse CSV",
              "targetStep": "/api/3/workflow_steps/a355b90e-9dcd-40f5-b75d-e2f8040db6a3",
              "sourceStep": "/api/3/workflow_steps/ebe5e858-be6b-4bb8-8468-ea0c19cac67c",
              "label": null,
              "isExecuted": false,
              "group": null,
              "uuid": "97e7a5c6-4f8f-4b0d-9a2b-0c8c7d4f2e11"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Parse CSV -> Ingest CIS Rules",
              "targetStep": "/api/3/workflow_steps/ebf12744-2bf9-495c-ac66-ea4ccd40b870",
              "sourceStep": "/api/3/workflow_steps/a355b90e-9dcd-40f5-b75d-e2f8040db6a3",
              "label": null,
              "isExecuted": false,
              "group": null,
              "uuid": "b5b7cbd4-7f8a-4c0b-9a0c-3b1d2f4e5c6a"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Ingest CIS Rules -> Done",
              "targetStep": "/api/3/workflow_steps/acd035fe-ea4b-4f0b-ae78-4132e55ae9b3",
              "sourceStep": "/api/3/workflow_steps/ebf12744-2bf9-495c-ac66-ea4ccd40b870",
              "label": null,
              "isExecuted": false,
              "group": null,
              "uuid": "d2a1b9c4-3e2f-4a8b-9c1d-5f6a7b8c9d0e"
            }
          ],
          "groups": [],
          "priority": "/api/3/picklists/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
          "playbookOrigin": "/api/3/picklists/15c1e8c9-22bf-4e66-8fbb-0a502d4a4a3f",
          "isEditable": true,
          "uuid": "439c8623-a812-49f9-a27b-ef1e5af53596",
          "owners": [],
          "isPrivate": false,
          "deletedAt": null,
          "importedBy": [],
          "recordTags": []
        }
      ]
    }
  ],
  "exported_tags": []
}
